"use strict";!function(){function pushContent(attrs){var textOk,typeOk;(!textFilter&&typeFilter===MEDIA_TYPE_NONE||(textOk=attrs.name&&-1!==attrs.name.toLowerCase().indexOf(textFilter.toLowerCase()),typeOk=attrs.type===typeFilter||typeFilter===MEDIA_TYPE_NONE,textOk&&typeOk))&&(-1!==listLink.parent.playable.indexOf(attrs.type)?listLink.playList.push(attrs):attrs.type===MEDIA_TYPE_TEXT&&listLink.subList.push(attrs),-1===listLink.mtypes.indexOf(attrs.type)&&listLink.mtypes.push(attrs.type),content.push(attrs))}function openError(){new CModalAlert(listLink.parent,_("Error"),_("Unknown type of selected item"),_("Close"))}function fileSort(list,sortType){return list=list||[],Array.isArray(list)&&list.length>0&&(list.sort(function(a,b){return a.name.toLowerCase().localeCompare(b.name.toLowerCase())}),sortType===MEDIA_ACTION_SORT_TYPE&&void 0!==list[0].type?list.sort(function(a,b){return a.type-b.type}):sortType===MEDIA_ACTION_SORT_EXT&&void 0!==list[0].ext?list.sort(function(a,b){return a.ext.toLowerCase().localeCompare(b.ext.toLowerCase())}):sortType===MEDIA_ACTION_SORT_SIZE&&void 0!==list[0].size&&list.sort(function(a,b){return a.size-b.size})),list}function listDir(path){var dirs=[],files=[],data={dirs:[],files:[],url:path},result;if(void 0!==path&&""!==path){result=gSTB.ListDir(path,!1),MediaExplorer.isStrictMode&&(result=result.replace("var dirs = [","dirs = [").replace("var files = [","files = ["));try{eval(result)}catch(e){echo(e),dirs=[],files=[]}Array.isArray(dirs)&&dirs.length>0&&(dirs=dirs.filter(function(dir){return""!==dir}),dirs.forEach(function(dir){dir=dir.slice(0,-1),dir&&data.dirs.push({name:dir,type:MEDIA_TYPE_FOLDER})})),Array.isArray(files)&&files.length>0&&(files=files.filter(function(file){return void 0!==file.name}),files.forEach(function(file){file.ext=file.name.split(".").pop(),file.type=listLink.ext2type[file.ext.toLowerCase()]}),data.files=files)}return data}function openRoot(data,level){var i,len,isRecords=!1;for(textFilter&&content.push({name:"..",type:MEDIA_TYPE_BACK}),CURRENT_NETWORK_STATE&&(pushContent({name:_("Network"),markable:!1,readOnly:!0,type:MEDIA_TYPE_SAMBA_ROOT}),""!==environment.upnp_conf&&"off"!==environment.upnp_conf&&pushContent(window.stbUPnP&&window.stbUPnP.getServerListSync?{name:"UPnP",markable:!1,readOnly:!0,url:"/UPnP",type:MEDIA_TYPE_UPNP_ROOT}:{name:"UPnP",markable:!1,readOnly:!0,url:PATH_MEDIA+"UPnP",type:MEDIA_TYPE_UPNP})),STORAGE_INFO.forEach(function(item){gSTB.IsFolderExist(item.mountPath+"/records")&&(isRecords=!0)}),isRecords&&pushContent({name:_("Records"),markable:!1,readOnly:!0,type:MEDIA_TYPE_RECORDS_ROOT}),pushContent({name:_("Favourites"),markable:!1,readOnly:!0,type:MEDIA_TYPE_FAVORITES}),i=0,len=STORAGE_INFO.length;len>i;++i)pushContent({name:STORAGE_INFO[i].label,markable:!1,readOnly:Boolean(STORAGE_INFO[i].isReadOnly),url:STORAGE_INFO[i].mountPath,size:STORAGE_INFO[i].size,free:STORAGE_INFO[i].freeSize,type:STORAGE_INFO[i].mediaType,fsType:STORAGE_INFO[i].fsType});if(CURRENT_NETWORK_STATE){for(i=0,len=SMB_ARRAY.length;len>i;++i)void 0===SMB_ARRAY[i].automount&&pushContent({name:SMB_ARRAY[i].local,markable:!1,readOnly:!0,url:SMB_PATH,address:"//"+SMB_ARRAY[i].url+"/"+SMB_ARRAY[i].folder,link:SMB_ARRAY[i],type:MEDIA_TYPE_SAMBA_SHARE});for(i=0,len=NFS_ARRAY.length;len>i;++i)void 0===NFS_ARRAY[i].automount&&pushContent({name:NFS_ARRAY[i].local,markable:!1,readOnly:!0,url:NFS_PATH,address:NFS_ARRAY[i].url+":"+NFS_ARRAY[i].folder,link:NFS_ARRAY[i],type:MEDIA_TYPE_NFS_SHARE})}listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openBack(){if(echo("openBack"),listLink.bcrumb&&listLink.bcrumb.Pop(),listLink.path.length>1){if(listLink.mode===MEDIA_TYPE_FAVORITES&&FAVORITES_CHANGED)return void new CModalConfirm(listLink.parent,_("The list of favourite records has changed"),_("Save updated list of favourite records?"),_("Exit without saving"),function(){listLink.parent.FavRestore(),listLink.Open({type:MEDIA_TYPE_BACK})},_("Save"),function(){listLink.parent.FavSave(),listLink.Open({type:MEDIA_TYPE_BACK})});listLink.path.pop(),textFilter=listLink.path[listLink.path.length-1].filterText?listLink.path[listLink.path.length-1].filterText:"",typeFilter=MEDIA_TYPE_NONE,FileBrowser.open(listLink.path[listLink.path.length-1],listLink.LEVEL_CHANGE_UP)}}function openSambaRoot(data,level){var groups=null;try{groups=JSON.parse(gSTB.GetSmbGroups()),echo(groups,"gSTB.GetSmbGroups")}catch(e){echo(e)}groups&&Array.isArray(groups.result)&&groups.result.length>0?(content.push({name:"..",type:MEDIA_TYPE_BACK}),groups.result.forEach(function(group){group&&pushContent({markable:!1,readOnly:data.readOnly,name:group,url:group,type:MEDIA_TYPE_SAMBA_GROUP})}),listLink.total=content.length,listLink.onLevelChange(data,content,level)):new CModalAlert(listLink.parent,_("Error"),_("Unable to get working group list")+(groups.errMsg?":<br>"+groups.errMsg:"."),_("Close"),function(){setTimeout(function(){listLink.Activate(!0)},5)})}function openSambaGroup(data,level){var servers=null;try{servers=JSON.parse(gSTB.GetSmbServers(JSON.stringify({group:data.name}))),echo(servers,"gSTB.GetSmbServers")}catch(e){echo(e)}servers&&Array.isArray(servers.result)&&servers.result.length>0?(content.push({name:"..",type:MEDIA_TYPE_BACK}),servers.result.forEach(function(server){server&&pushContent({markable:!1,readOnly:data.readOnly,name:server,url:data.url+"/"+server,type:MEDIA_TYPE_SAMBA_HOST})}),listLink.total=content.length,listLink.onLevelChange(data,content,level)):new CModalAlert(listLink.parent,_("Error"),_("Unable to get working group servers")+(servers.errMsg?":<br>"+servers.errMsg:"."),_("Close"),function(){setTimeout(function(){listLink.Activate(!0)},5)})}function openSambaHost(data,level){var shares=null;try{shares=JSON.parse(gSTB.GetSmbShares(JSON.stringify({server:data.name}))),echo(shares,"gSTB.GetSmbShares")}catch(e){echo(e)}listLink.parent.UnmountSMB(),shares&&shares.result&&Array.isArray(shares.result.shares)&&shares.result.shares.length>0?(content.push({name:"..",type:MEDIA_TYPE_BACK}),shares.result.shares.forEach(function(share){share&&pushContent({name:share,markable:!1,readOnly:data.readOnly,url:SMB_PATH,address:"//"+shares.result.serverIP+"/"+share,folder:share,type:MEDIA_TYPE_SAMBA_SHARE})}),listLink.total=content.length,listLink.onLevelChange(data,content,level)):new CModalAlert(listLink.parent,_("Error"),_("Unable to get server shares")+(shares.errMsg?":<br>"+shares.errMsg:"."),_("Close"),function(){setTimeout(function(){listLink.Activate(!0)},5)})}function openFolder(data,level){var result=listDir(data.url),isISO=!1;content.push({name:"..",type:MEDIA_TYPE_BACK}),fileSort(result.dirs,MEDIA_ACTION_SORT_NAME).concat(fileSort(result.files,listLink.sortType)).forEach(function(item){item.url=data.url+"/"+item.name,item.markable=!0,item.readOnly=content.readOnly,void 0!==content.fsType&&"records"===item.name&&(item.readOnly=!0,item.markable=!1),-1!==["VIDEO_TS","BDMV","video_ts","bdmv","video_ts.ifo","VIDEO_TS.IFO"].indexOf(item.name)&&(isISO=!0),item.stared=item.markable&&FAVORITES_NEW[item.url]?!0:!1,echo(item.type,"item.type"),pushContent(item)}),isISO&&setTimeout(function(){new CModalConfirm(listLink.parent,_("Multimedia content"),_("The directory contains DVD or Blu-ray structure.<br>Begin playing?"),_("Cancel"),function(){},_("Yes"),function(){MediaPlayer.preparePlayer({name:data.name,url:data.url,type:MEDIA_TYPE_ISO},listLink.parent,!0,!0,!listLink.parent.BPanel.btnF3add.data.hidden||!listLink.parent.BPanel.btnF3del.data.hidden,!1)})},5),result.dirs.length+result.files.length>0&&(listLink.hideF3add=!1,listLink.hideF2=!1),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openSambaShare(data,level){var modalAuth,currFocus;listLink.parent.MountSMB(data)?openFolder({name:data.name,url:SMB_PATH,type:MEDIA_TYPE_FOLDER},level):(currFocus=document.activeElement,new CModalConfirm(listLink.parent,_("Network connection"),_("Unable to mount the folder.<br>Authorization may be necessary.<br>Specify login and password?"),_("Cancel"),function(){currFocus.focus()},_("Yes"),function(){modalAuth=new CModalAuth(listLink.parent,_("Authorization"),_("Login:"),_("Password:"),_("Cancel"),function(){listLink.prevFocus=currFocus},_("Connection"),function(login,pass){return SMB_AUTH[data.address]={login:login,pass:pass},listLink.parent.MountSMB(data)?(listLink.prevFocus=currFocus,setTimeout(function(){listLink.Open(data)},5),!0):(echo(modalAuth.name),new CModalHint(modalAuth,_("Unable to connect to the resource<br>with the given parameters"),4e3),!1)})}))}function openNFSShare(data,level){return this.parent.MountNFS(data)?void openFolder({name:data.name,url:NFS_PATH}):void new CModalHint(this.parent,_("Unable to connect to the resource<br>with the given parameters"),4e3)}function openFavorites(data,level){var path;content.push({name:"..",type:MEDIA_TYPE_BACK});for(path in FAVORITES_NEW)FAVORITES_NEW.hasOwnProperty(path)&&(FAVORITES_NEW[path].markable=!0,FAVORITES_NEW[path].stared=!1,pushContent(FAVORITES_NEW[path]));content.length>1&&(listLink.hideF2=listLink.hideF3del=!1),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openFavoriteItem(data,level){var path;content.push({name:"..",type:MEDIA_TYPE_BACK});for(path in FAVORITES_NEW)FAVORITES_NEW.hasOwnProperty(path)&&(FAVORITES_NEW[path].markable=!0,FAVORITES_NEW[path].stared=!1,pushContent(FAVORITES_NEW[path]));content.length>1&&(listLink.hideF2=listLink.hideF3del=!1),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openRecordsFolder(paths){var dHash={},dList=[];paths.forEach(function(path){listDir(path).dirs.forEach(function(dir){dHash[dir.name]=dHash[dir.name]||[],dHash[dir.name].push(path+"/"+dir.name)})});for(var name in dHash)dHash.hasOwnProperty(name)&&dList.push({name:name,url:name,paths:dHash[name]});return fileSort(dList,MEDIA_ACTION_SORT_NAME)}function openRecordsRoot(data,level){var path,paths=[];content.push({name:"..",type:MEDIA_TYPE_BACK}),STORAGE_INFO.forEach(function(item){path=item.mountPath+"/records",gSTB.IsFolderExist(path)&&paths.push(path)}),openRecordsFolder(paths).forEach(function(item){item.type=MEDIA_TYPE_RECORDS_CHAN,pushContent(item)}),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openRecordsChan(data,level){content.push({name:"..",type:MEDIA_TYPE_BACK}),openRecordsFolder(data.paths).forEach(function(item){item.type=MEDIA_TYPE_RECORDS_CHAN,pushContent(item)}),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openRecordsDate(data,level){var list=[];content.push({name:"..",type:MEDIA_TYPE_BACK}),data.paths.forEach(function(path){listDir(path).files.forEach(function(item){item.url=path+"/"+item.name,list.push(item)})}),list=fileSort(list,listLink.sortType),list.forEach(function(item){item.markable=!0,item.name=item.name.split("-").join(":"),item.stared=FAVORITES_NEW[item.url]?!0:!1,pushContent(item)}),list.length>0&&(listLink.hideF2=listLink.listLink=!1),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openFile(data){listLink.timer&&clearTimeout(listLink.timer),listLink.playListSet||(MediaPlayer.prepareList(listLink.playList),MediaPlayer.setSubList(listLink.subList),listLink.playListSet=!0),MediaPlayer.playNow||null!==MediaPlayer.obj?(MediaPlayer.Show(!0,listLink.parent),setTimeout(function(){MediaPlayer.changeScreenMode(!0)},0)):MediaPlayer.preparePlayer(data,listLink.parent,!0,!0,!listLink.parent.BPanel.btnF3add.data.hidden||!listLink.parent.BPanel.btnF3del.data.hidden,!1)}function openText(data){gSTB.IsFileUTF8Encoded(data.url)?(MediaPlayer.setForcedSubtitles(data,"utf-8"),new CModalHint(currCPage,_("Selected subtitle will appear<br>during next player launch"),3e3)):new CModalSubtitleOpen(listLink.parent,{data:data,onadd:function(options,encoding){MediaPlayer.setForcedSubtitles(options.data,encoding),new CModalHint(currCPage,_("Selected subtitle will appear<br>during next player launch"),3e3)}})}function openCue(data,level){void 0===data.cue&&(data.cue=listLink.parent.ParseCue(gSTB.RDir('GetFile "'+data.url+'"'))),content.push({name:"..",type:MEDIA_TYPE_BACK}),data.cue.files.forEach(function(file){file.tracks.forEach(function(track){var info={name:track.number+". "+track.title,type:MEDIA_TYPE_CUE_ITEM,time:track.index[track.index.length-1]||0,url:listLink.parentItem.url+"/"+file.name};data.cue.files.length>1&&(info.file=file.name),track.performer!==data.cue.performer&&void 0!==track.performer&&(info.performer=track.performer),pushContent(info)})}),listLink.total=content.length,listLink.onLevelChange(data,content,level)}function openPlaylist(data,level){var plsData,code=data.code;if(data.readOnly=!0,data.filterText&&(code=KEYS.F1),void 0===code)return void setTimeout(function(){new CModalPlayListOpen(listLink.parent)},5);if(plsData=listLink.parent.ParsePlaylist(data.ext,listLink.parent.ReadFile(encodeURI(data.url),data.encoding)),0===plsData.length)return void new CModalAlert(listLink.parent,_("Error"),_("No records in this playlist"),_("Close"));switch(data.code=null,code){case KEYS.F1:case KEYS.F2:content.push({name:"..",type:MEDIA_TYPE_BACK}),plsData.forEach(function(item){item.markable=!0,item.stared=FAVORITES_NEW[item.url]?!0:!1,pushContent(item)}),plsData.length>0&&(listLink.hideF2=listLink.hideF3add=!1),code===KEYS.F2&&(setTimeout(function(){listLink.Reposition(plsData[0]),listLink.onFocus(listLink.Current())},0),MediaPlayer.prepareList(plsData),listLink.playListSet=!0,MediaPlayer.preparePlayer(plsData[0]||{},listLink.parent,!0,!0,!0,!0)),listLink.onLevelChange(data,content,level);break;case KEYS.F3:setTimeout(function(){var result=IPTVChannels.addChannels(plsData,!0);if(result===!1)new CModalAlert(listLink.parent,_("Add to IPTV channels"),_("Unable to add the selected records"),_("Close"));else if(0===result)new CModalAlert(listLink.parent,_("Add to IPTV channels"),_("No new channels for selected records"),_("Close"));else{var conf=new CModalAlert(listLink.parent,_("Add to IPTV channels"),_("Channels added successfully:")+" "+result,_("Close"));conf.bpanel.Add(KEYS.TV,"tv.png",_("Go to IPTV channels"),function(){return conf.Show(!1),MediaExplorer.Reset(),MediaExplorer.Show(!1),IPTVChannels.Reset(),IPTVChannels.Show(!0),!0})}},5)}}function route(data,level){content=[],listLink.Clear(),level=level||listLink.LEVEL_CHANGE_DOWN,data&&routes[data.type]?(listLink.fileBrowser=FileBrowser,data.realType===MEDIA_TYPE_FAVORITE_ITEM?openFavoriteItem(data,level):routes[data.type](data,level)):openError(data,level)}var routes={},textFilter="",typeFilter=MEDIA_TYPE_NONE,listLink,content;window.FileBrowser={init:function(list){listLink=list,routes[MEDIA_TYPE_ROOT_MB]=openRoot,routes[MEDIA_TYPE_BACK]=openBack,routes[MEDIA_TYPE_SAMBA_ROOT]=openSambaRoot,routes[MEDIA_TYPE_SAMBA_GROUP]=openSambaGroup,routes[MEDIA_TYPE_SAMBA_HOST]=openSambaHost,routes[MEDIA_TYPE_SAMBA_SHARE]=openSambaShare,routes[MEDIA_TYPE_NFS_SHARE]=openNFSShare,routes[MEDIA_TYPE_FOLDER]=openFolder,routes[MEDIA_TYPE_STORAGE_USB]=openFolder,routes[MEDIA_TYPE_STORAGE_SATA]=openFolder,routes[MEDIA_TYPE_STORAGE_SD]=openFolder,routes[MEDIA_TYPE_UPNP]=openFolder,routes[MEDIA_TYPE_FAVORITES]=openFavorites,routes[MEDIA_TYPE_RECORDS_ROOT]=openRecordsRoot,routes[MEDIA_TYPE_RECORDS_CHAN]=openRecordsChan,routes[MEDIA_TYPE_RECORDS_DATE]=openRecordsDate,routes[MEDIA_TYPE_RECORDS_ITEM]=openFile,routes[MEDIA_TYPE_VIDEO]=openFile,routes[MEDIA_TYPE_AUDIO]=openFile,routes[MEDIA_TYPE_IMAGE]=openFile,routes[MEDIA_TYPE_ISO]=openFile,routes[MEDIA_TYPE_STREAM]=openFile,routes[MEDIA_TYPE_DVB]=openFile,routes[MEDIA_TYPE_CUE]=openCue,routes[MEDIA_TYPE_CUE_ITEM]=openFile,routes[MEDIA_TYPE_TEXT]=openText,routes[MEDIA_TYPE_PLAYLIST]=openPlaylist,routes[MEDIA_TYPE_UPNP_ROOT]=function(data,level){UPnPBrowser&&UPnPBrowser.open(data,level)},window.FileBrowser={open:route,filterText:function(text){var clone={},last=listLink.path[listLink.path.length-1];textFilter=text;for(var attr in last)clone[attr]=last[attr];clone.filterText=text,listLink.Open(clone)},filterType:function(type){var typeOk,textOk,data;typeFilter=type,data=content.filter(function(item){return textOk=item.type===MEDIA_TYPE_BACK||item.name&&-1!==item.name.toLowerCase().indexOf(textFilter),typeOk=item.type===typeFilter||typeFilter===MEDIA_TYPE_NONE||item.type===MEDIA_TYPE_BACK,textOk&&typeOk}),listLink.data=data,listLink.indexView=-1,listLink.total=data.length,listLink.renderView(0),listLink.activeItem.data||listLink.focusItem(listLink.$body.firstChild)}}}}}();